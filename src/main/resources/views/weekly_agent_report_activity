CREATE  VIEW `weekly_agent_report_activity` AS
    select 
        `a`.`war_activity_school_year` AS `report_school_year`,
        `a`.`war_planner` AS `report_planner_id`,
        `a`.`war_activity_region_code` AS `report_region`,
        `wc`.`customer_id` AS `report_customer_id`,
        `wr`.`market_potential_segment` AS `report_market_potential_segment`,
        `wr`.`market_potential` AS `report_market_potential`,
        `wa`.`war_agent_id` AS `report_agent_id`,
        `fud`.`full_name` AS `report_materials_advisor`,
        `a`.`start_dt` AS `report_date`,
        `a`.`war_planner_month` AS `report_month`,
        year(`a`.`start_dt`) AS `report_year`,
        `a`.`war_activity_week` AS `report_week`,
        sum(if((`a`.`war_activity_worked_with` = 1),
                    1,
                    0)) AS `report_worked_with`,
        sum(if((`a`.`war_activity_planned` = 1),
            1,
            0)) AS `report_planned_target`,
        sum(if((`a`.`war_activity_planned` = 0),
            1,
            0)) AS `report_unplanned_target`,
        sum((if((`a`.`war_activity_planned` = 1),
            1,
            0)
            and if((`a`.`war_activity_actual` = 1),
            1,
            0))) AS `report_planned_actual`,
        sum((if((`a`.`war_activity_planned` = 0),
            1,
            0)
            and if((`a`.`war_activity_actual` = 1),
            1,
            0))) AS `report_unplanned_actual`,
        count(`a`.`war_activity_id`) AS `report_total_activity`,
        sum(if((`a`.`war_activity_actual` = 1),
            1,
            0)) AS `report_total_actual`,
        ((100 / count(`a`.`war_activity_id`)) * sum((if((`a`.`war_activity_planned` = 1),
            1,
            0)
            and if((`a`.`war_activity_actual` = 1),
            1,
            0)))) AS `report_planned_call_productivity`,
        ((100 / count(`a`.`war_activity_id`)) * sum((if((`a`.`war_activity_planned` = 0),
            1,
            0)
            and if((`a`.`war_activity_actual` = 1),
            1,
            0)))) AS `report_unplanned_call_productivity`,
        ((100 / count(`a`.`war_activity_id`)) * sum(if((`a`.`war_activity_actual` = 1),
            1,
            0))) AS `report_total_call_productivity`,
        ((100 * count(if((`a`.`war_activity_planned` = 1),
            1,
            0))) / sum(if((`a`.`war_activity_actual` = 1),
            1,
            0))) AS `report_call_productivity`,
        sum(if((`a`.`war_activity_exam_copies_distribution` = 1),
            1,
            0)) AS `report_exam_copies_distribution`,
        sum(if((`a`.`war_activity_invitation_to_events` = 1),
            1,
            0)) AS `report_invitation_to_events`,
        sum(if((`a`.`war_activity_confirmation_of_events` = 1),
            1,
            0)) AS `report_confirmation_of_events`,
        sum(if((`a`.`war_activity_giveaways_distribution` = 1),
            1,
            0)) AS `report_giveaways_distribution`,
        sum(if((`a`.`war_activity_delivery_of_incentive_donation` = 1),
            1,
            0)) AS `report_delivery_of_incentive_donation`,
        sum(if((`a`.`war_activity_purchase_order` = 1),
            1,
            0)) AS `report_purchase_order`,
        sum(if((`a`.`war_activity_delivery_of_additional_order_trm_compliance` = 1),
            1,
            0)) AS `report_delivery_of_additional_order_trm_compliance`,
        sum(if((`a`.`war_activity_book_list` = 1),
            1,
            0)) AS `report_book_list`,
        sum(if((`a`.`war_activity_updated_customer_info_sheet` = 1),
            1,
            0)) AS `report_updated_customer_info_sheet`,
        sum(if((`a`.`war_activity_implemented_ex_sem` = 1),
            1,
            0)) AS `report_implemented_ex_sem`,
        sum(if((`a`.`war_activity_follow_up_payment` = 1),
            1,
            0)) AS `report_follow_up_payment` ,
        sum(if((`a`.`war_activity_customer_specific_activity` is not null), 1,0)) AS `report_customer_specific_activity`
    from
        ((((((`war_activity` `a`
        left join `customer_latest_market_view` `wr` ON ((`wr`.`war_customer_customer_id` = `a`.`war_activity_customer_market_id`)))
        join `war_customer` `wc` ON ((`wc`.`customer_id` = `a`.`war_activity_customer_market_id`)))
        join `war_agent` `wa` ON ((`wa`.`war_agent_id` = `a`.`war_activity_agent_id`)))
        join `flow_user` `fu` ON ((`fu`.`flow_user_id` = `wa`.`user`)))
        join `flow_user_detail` `fud` ON ((`fud`.`flow_user_detail_id` = `fu`.`flow_user_detail_id`)))
        join `war_customer_school` `ws` ON ((`ws`.`war_customer_school_id` = `wc`.`war_customer_school`)))
    group by `a`.`war_activity_week` , `fud`.`full_name` , `a`.`war_planner_month` , year(`a`.`start_dt`)
    order by `a`.`start_dt`